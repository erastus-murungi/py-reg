import pprint

import pytest

from reg.fsm import NFA, gen_state
from reg.nfa_matcher import RegexNFA
from reg.optimizer import Optimizer
from reg.parser import RegexParser, MATCH
from reg.utils import RegexFlag, Fragment


def get_n_transitions_epsilon_not_reduced(
    pattern: str, flags: RegexFlag = RegexFlag.OPTIMIZE
):
    nfa = NFA()
    parser = RegexParser(pattern, flags)
    Optimizer.run(parser.root)
    src, sink = parser.root.accept(nfa)
    accept_node = gen_state()
    nfa.add_transition(sink, accept_node, MATCH)
    nfa.set_terminals(Fragment(src, accept_node))
    nfa.update_symbols_and_states()
    return nfa.n_transitions()


@pytest.mark.parametrize(
    "pattern, upper_bound",
    [
        ("", 2),
        ("$", 2),
        ("$^", 4),
        ("$^$", 6),
        ("$b", 4),
        ("((((((((((((((((((((((((((((((x))))))))))))))))))))))))))))))", 92),
        ("((((((((((((((((((((((((((((((x))))))))))))))))))))))))))))))*", 96),
        ("((((((((((((((((((((x))))))))))))))))))))", 62),
        ("(((((((((a)))))))))", 29),
        ("((..)|(.))", 18),
        ("((..)|(.))((..)|(.))", 36),
        ("((..)|(.))((..)|(.))((..)|(.))", 54),
        ("((..)|(.))*", 22),
        ("((..)|(.)){1}", 18),
        ("((..)|(.)){2}", 36),
        ("((..)|(.)){3}", 54),
        ("((a)(b)c)(d)", 20),
        ("((a))", 8),
        ("((a|a)|a)", 18),
        ("((foo)|(bar))!bas", 18),
        ("((foo)|bar)!bas", 15),
        ("()ef", 7),
        ("(.*)c(.*)", 20),
        ("(..)*(...)*", 24),
        ("(.a|.b).*|.*(.a|.b)", 43),
        ("(Ab|cD)*", 14),
        ("([^.]*)\\.([^:]*):[T ]+(.*)", 35),
        ("([^/]*/)*sub1/", 17),
        ("([^N]*N)+", 13),
        ("([abc])*bcd", 11),
        ("([abc])*d", 11),
        ("([abc]*)x", 11),
        ("([ac])+x", 9),
        ("([xyz]*)x", 11),
        ("(a)(b)(c)", 15),
        ("(a)(b)c|ab", 17),
        ("(a)+b|aac", 14),
        ("(a)+x", 9),
        ("(a)b(c)", 12),
        ("(a*)(a|aa)", 19),
        ("(a*)(b?)(b+)b{3}", 28),
        ("(a*)(b{0,1})(b{1,})b{3}", 28),
        ("(a+|b)*", 16),
        ("(a+|b)+", 14),
        ("(a+|b)?", 13),
        ("(a+|b){0,1}", 13),
        ("(a+|b){0,}", 16),
        ("(a+|b){1,}", 14),
        ("(a.|.a.)*|(a|.a...)", 41),
        ("(aa|aaa)*|(a|aaaaa)", 27),
        ("(ab)c|abc", 12),
        ("(abc|)ef", 12),
        ("(ab|a)(bc|c)", 20),
        ("(ab|a)b*c", 18),
        ("(ab|ab*)bc", 18),
        ("(ab|cd)e", 12),
        ("(a|ab|c|bcd)*(d*)", 33),
        ("(a|ab|c|bcd)+(d*)", 31),
        ("(a|ab|c|bcd){0,10}(d*)", 219),
        ("(a|ab|c|bcd){0,}(d*)", 33),
        ("(a|ab|c|bcd){1,10}(d*)", 218),
        ("(a|ab|c|bcd){1,}(d*)", 31),
        ("(a|ab|c|bcd){2,10}(d*)", 217),
        ("(a|ab|c|bcd){2,}(d*)", 51),
        ("(a|ab|c|bcd){3,10}(d*)", 216),
        ("(a|ab|c|bcd){3,}(d*)", 71),
        ("(a|ab|c|bcd){4,10}(d*)", 215),
        ("(a|ab|c|bcd){4,}(d*)", 91),
        ("(a|b)*c|(a|ab)*c", 35),
        ("(a|b)?.*", 17),
        ("(a|b)c*d", 18),
        ("(a|b)c|a(b|c)", 27),
        ("(a|b|c|d|e)f", 27),
        ("(bc+d$|ef*g.|h?i(j|k))", 46),
        ("(foo\\$)", 5),
        ("(foo|(bar))!bas", 15),
        ("(foo|bar)!bas", 12),
        ("(foo|bar|[A-Z])$", 17),
        ("(foo|fo)", 10),
        ("(fo|foo)", 10),
        (".*(/000).*", 17),
        (".*(/XXX).*", 17),
        (".*(\\\\000).*", 17),
        (".*(\\\\XXX).*", 17),
        (":::1:::0:|:::1:1:0:", 7),
        (":::1:::0:|:::1:1:1:", 7),
        ("ABC", 2),
        ("M[ou]'?am+[ae]r_.*([AEae]l[-_])?[GKQ]h?[aeu]+([dtz][dhz]?)+af[iy]", 56),
        ("X(.?){0,8}Y", 60),
        ("X(.?){1,8}Y", 59),
        ("X(.?){2,8}Y", 58),
        ("X(.?){3,8}Y", 57),
        ("X(.?){4,8}Y", 56),
        ("X(.?){5,8}Y", 55),
        ("X(.?){6,8}Y", 54),
        ("X(.?){7,8}Y", 53),
        ("X(.?){8,8}Y", 52),
        ("X(.?){8,}Y", 54),
        ("[^\\s\\S]", 2),
        ("[^ab]*", 6),
        ("[^x]", 2),
        ("[^x]+", 4),
        ("[a-zA-Z_][a-zA-Z0-9_]*", 8),
        ("[abcd]", 2),
        ("[abcd]+", 4),
        ("[abhgefdc]ij", 4),
        ("[dz][ex][fy]$", 8),
        ("[k]", 2),
        ("\\((.*), (.*)\\)", 24),
        ("\\)", 2),
        ("\\Ba\\B", 6),
        ("\\Bx", 4),
        ("\\By\\B", 6),
        ("\\By\\b", 6),
        ("\\Bz", 4),
        ("\\\\000", 2),
        ("\\\\XXX", 2),
        ("\\]", 2),
        ("\\ba\\b", 6),
        ("\\by\\B", 6),
        ("\\by\\b", 6),
        ("\\}", 2),
        ("^", 2),
        ("^$", 4),
        ("^$$", 6),
        ("^$^", 6),
        ("^$^$", 8),
        ("^(([^!]+!)?([^!]+)|.+!([^!]+!)([^!]+))$", 49),
        ("^(.+)$", 11),
        ("^([^!.]+).att.com!(.+)$", 26),
        ("^([^!]+!)?([^!]+)$", 21),
        ("^([^!]+!)?([^!]+)$|^.+!([^!]+!)([^!]+)$", 50),
        ("^(ab|cd)e", 14),
        ("^(foo\\$)$", 9),
        ("^(foo|bar|[A-Z])", 17),
        ("^(foo|bar|[A-Z])$", 19),
        ("^(fo|foo)$", 14),
        ("^.+!([^!]+!)([^!]+)$", 26),
        ("^.+$", 8),
        ("^...$", 10),
        ("^[ay]*[bx]+c", 14),
        ("^^$", 6),
        ("^^$$", 8),
        ("^^(fo|foo)$", 16),
        ("^^^^^^^^$$$$$$$$", 32),
        ("^a(bc+|b[eh])g|.h$", 31),
        ("^a*?$", 10),
        ("^abc", 4),
        ("^abc$", 6),
        ("a", 2),
        ("a($)", 7),
        ("a([bc]*)(c*d)", 22),
        ("a([bc]*)(c+d)", 20),
        ("a([bc]*)c*", 17),
        ("a([bc]+)(c*d)", 20),
        ("a(b)|c(d)|a(e)f", 29),
        ("a(bc)d", 9),
        ("a*", 6),
        ("a*(^a)", 13),
        ("a*(a.|aa)", 18),
        ("a*a*a*a*a*b", 32),
        ("a*b", 8),
        ("a+", 4),
        ("a+(b|c)*d+", 22),
        ("a+b+c", 10),
        ("a.*c", 10),
        ("a.c", 6),
        ("a?(ab|ba)*", 17),
        ("a?(ab|ba)ab", 15),
        ("a?(ac{0}b|ba)ab", 19),
        ("a[\x01-\x03]?c", 7),
        ("a[-]?c", 7),
        ("a[-b]", 4),
        ("a[\\-b]", 4),
        ("a[\\]]b", 6),
        ("a[^-b]c", 6),
        ("a[^>]*?b", 10),
        ("a[^\\]b]c", 6),
        ("a[^bc]d", 6),
        ("a[b-d]", 4),
        ("a[b-d]e", 6),
        ("a[bc]d", 6),
        ("a[bcd]*dcdcde", 10),
        ("a[bcd]+dcdcde", 8),
        ("a\\(*b", 10),
        ("a\\(b", 2),
        ("a\\\\b", 2),
        ("a\\]", 2),
        ("aa", 2),
        ("aaaa|bbbb|cccc|ddddd|eeeeee|fffffff|gggg|hhhh|iiiii|jjjjj|kkkkk|llll", 57),
        ("aaac|aabc|abac|abbc|baac|babc|bbac|bbbc", 37),
        ("ab*", 8),
        ("ab*bc", 10),
        ("ab*c", 10),
        ("ab+bc", 8),
        ("ab?bc", 7),
        ("ab?c", 7),
        ("abaa|abbaa|abbbaa|abbbbaa", 17),
        ("aba|bab", 7),
        ("aba|bab|bba", 12),
        ("abc", 2),
        ("abc$", 4),
        ("abcd*efg", 10),
        ("ab{0,1}bc", 7),
        ("ab{0,1}c", 7),
        ("ab{0,}bc", 10),
        ("ab{1,3}bc", 12),
        ("ab{1,}bc", 8),
        ("ab{3,4}bc", 13),
        ("ab{4,5}bc", 15),
        ("ab|a", 7),
        ("ab|abab", 7),
        ("ab|cd", 7),
        ("a{0}b", 4),
        ("a{1,}b{1,}c", 10),
        ("a|b|c|d|e", 22),
        ("d[ex][fy]$", 8),
        ("def$", 4),
        ("foo|bar|[A-Z]", 12),
        ("h.*o", 10),
        ("h.*od?", 13),
        ("multiple words", 2),
        ("multiple words of text", 2),
        ("x\\B", 4),
        ("x\\b", 4),
        ("z\\B", 4),
    ],
)
def _test_original_num_epsilons(pattern, upper_bound):
    assert get_n_transitions_epsilon_not_reduced(pattern) <= upper_bound


@pytest.mark.parametrize(
    "pattern, upper_bound",
    [
        ("", 2),
        ("$", 2),
        ("$^", 3),
        ("$^$", 4),
        ("$b", 3),
        ("((((((((((((((((((((((((((((((x))))))))))))))))))))))))))))))", 92),
        ("((((((((((((((((((((((((((((((x))))))))))))))))))))))))))))))*", 95),
        ("((((((((((((((((((((x))))))))))))))))))))", 62),
        ("(((((((((a)))))))))", 29),
        ("((..)|(.))", 14),
        ("((..)|(.))((..)|(.))", 27),
        ("((..)|(.))((..)|(.))((..)|(.))", 40),
        ("((..)|(.))*", 17),
        ("((..)|(.)){1}", 14),
        ("((..)|(.)){2}", 27),
        ("((..)|(.)){3}", 40),
        ("((a)(b)c)(d)", 17),
        ("((a))", 8),
        ("((a|a)|a)", 12),
        ("((foo)|(bar))!bas", 14),
        ("((foo)|bar)!bas", 11),
        ("()ef", 6),
        ("(.*)c(.*)", 16),
        ("(..)*(...)*", 19),
        ("(.a|.b).*|.*(.a|.b)", 26),
        ("(Ab|cD)*", 10),
        ("([^.]*)\\.([^:]*):[T ]+(.*)", 26),
        ("([^/]*/)*sub1/", 13),
        ("([^N]*N)+", 10),
        ("([abc])*bcd", 9),
        ("([abc])*d", 9),
        ("([abc]*)x", 9),
        ("([ac])+x", 7),
        ("([xyz]*)x", 9),
        ("(a)(b)(c)", 13),
        ("(a)(b)c|ab", 12),
        ("(a)+b|aac", 9),
        ("(a)+x", 7),
        ("(a)b(c)", 10),
        ("(a*)(a|aa)", 14),
        ("(a*)(b?)(b+)b{3}", 21),
        ("(a*)(b{0,1})(b{1,})b{3}", 21),
        ("(a+|b)*", 11),
        ("(a+|b)+", 9),
        ("(a+|b)?", 9),
        ("(a+|b){0,1}", 9),
        ("(a+|b){0,}", 11),
        ("(a+|b){1,}", 9),
        ("(a.|.a.)*|(a|.a...)", 24),
        ("(aa|aaa)*|(a|aaaaa)", 17),
        ("(ab)c|abc", 8),
        ("(abc|)ef", 8),
        ("(ab|a)(bc|c)", 13),
        ("(ab|a)b*c", 12),
        ("(ab|ab*)bc", 12),
        ("(ab|cd)e", 8),
        ("(a|ab|c|bcd)*(d*)", 21),
        ("(a|ab|c|bcd)+(d*)", 19),
        ("(a|ab|c|bcd){0,10}(d*)", 118),
        ("(a|ab|c|bcd){0,}(d*)", 21),
        ("(a|ab|c|bcd){1,10}(d*)", 117),
        ("(a|ab|c|bcd){1,}(d*)", 19),
        ("(a|ab|c|bcd){2,10}(d*)", 116),
        ("(a|ab|c|bcd){2,}(d*)", 29),
        ("(a|ab|c|bcd){3,10}(d*)", 115),
        ("(a|ab|c|bcd){3,}(d*)", 39),
        ("(a|ab|c|bcd){4,10}(d*)", 114),
        ("(a|ab|c|bcd){4,}(d*)", 49),
        ("(a|b)*c|(a|ab)*c", 22),
        ("(a|b)?.*", 12),
        ("(a|b)c*d", 12),
        ("(a|b)c|a(b|c)", 16),
        ("(a|b|c|d|e)f", 14),
        ("(bc+d$|ef*g.|h?i(j|k))", 27),
        ("(foo\\$)", 5),
        ("(foo|(bar))!bas", 11),
        ("(foo|bar)!bas", 8),
        ("(foo|bar|[A-Z])$", 10),
        ("(foo|fo)", 7),
        ("(fo|foo)", 7),
        (".*(/000).*", 13),
        (".*(/XXX).*", 13),
        (".*(\\\\000).*", 13),
        (".*(\\\\XXX).*", 13),
        (":::1:::0:|:::1:1:0:", 4),
        (":::1:::0:|:::1:1:1:", 4),
        ("ABC", 2),
        ("M[ou]'?am+[ae]r_.*([AEae]l[-_])?[GKQ]h?[aeu]+([dtz][dhz]?)+af[iy]", 36),
        ("X(.?){0,8}Y", 51),
        ("X(.?){1,8}Y", 50),
        ("X(.?){2,8}Y", 49),
        ("X(.?){3,8}Y", 48),
        ("X(.?){4,8}Y", 47),
        ("X(.?){5,8}Y", 46),
        ("X(.?){6,8}Y", 45),
        ("X(.?){7,8}Y", 44),
        ("X(.?){8,8}Y", 43),
        ("X(.?){8,}Y", 44),
        ("[^\\s\\S]", 2),
        ("[^ab]*", 5),
        ("[^x]", 2),
        ("[^x]+", 3),
        ("[a-zA-Z_][a-zA-Z0-9_]*", 6),
        ("[abcd]", 2),
        ("[abcd]+", 3),
        ("[abhgefdc]ij", 3),
        ("[dz][ex][fy]$", 5),
        ("[k]", 2),
        ("\\((.*), (.*)\\)", 18),
        ("\\)", 2),
        ("\\Ba\\B", 4),
        ("\\Bx", 3),
        ("\\By\\B", 4),
        ("\\By\\b", 4),
        ("\\Bz", 3),
        ("\\\\000", 2),
        ("\\\\XXX", 2),
        ("\\]", 2),
        ("\\ba\\b", 4),
        ("\\by\\B", 4),
        ("\\by\\b", 4),
        ("\\}", 2),
        ("^", 2),
        ("^$", 3),
        ("^$$", 4),
        ("^$^", 4),
        ("^$^$", 5),
        ("^(([^!]+!)?([^!]+)|.+!([^!]+!)([^!]+))$", 33),
        ("^(.+)$", 8),
        ("^([^!.]+).att.com!(.+)$", 17),
        ("^([^!]+!)?([^!]+)$", 15),
        ("^([^!]+!)?([^!]+)$|^.+!([^!]+!)([^!]+)$", 32),
        ("^(ab|cd)e", 9),
        ("^(foo\\$)$", 7),
        ("^(foo|bar|[A-Z])", 10),
        ("^(foo|bar|[A-Z])$", 11),
        ("^(fo|foo)$", 9),
        ("^.+!([^!]+!)([^!]+)$", 17),
        ("^.+$", 5),
        ("^...$", 6),
        ("^[ay]*[bx]+c", 9),
        ("^^$", 4),
        ("^^$$", 5),
        ("^^(fo|foo)$", 10),
        ("^^^^^^^^$$$$$$$$", 17),
        ("^a(bc+|b[eh])g|.h$", 17),
        ("^a*?$", 7),
        ("^abc", 3),
        ("^abc$", 4),
        ("a", 2),
        ("a($)", 6),
        ("a([bc]*)(c*d)", 17),
        ("a([bc]*)(c+d)", 15),
        ("a([bc]*)c*", 13),
        ("a([bc]+)(c*d)", 15),
        ("a(b)|c(d)|a(e)f", 19),
        ("a(bc)d", 7),
        ("a*", 5),
        ("a*(^a)", 10),
        ("a*(a.|aa)", 12),
        ("a*a*a*a*a*b", 33),
        ("a*b", 6),
        ("a+", 3),
        ("a+(b|c)*d+", 14),
        ("a+b+c", 6),
        ("a.*c", 7),
        ("a.c", 4),
        ("a?(ab|ba)*", 12),
        ("a?(ab|ba)ab", 10),
        ("a?(ac{0}b|ba)ab", 12),
        ("a[\x01-\x03]?c", 5),
        ("a[-]?c", 5),
        ("a[-b]", 3),
        ("a[\\-b]", 3),
        ("a[\\]]b", 4),
        ("a[^-b]c", 4),
        ("a[^>]*?b", 7),
        ("a[^\\]b]c", 4),
        ("a[^bc]d", 4),
        ("a[b-d]", 3),
        ("a[b-d]e", 4),
        ("a[bc]d", 4),
        ("a[bcd]*dcdcde", 7),
        ("a[bcd]+dcdcde", 5),
        ("a\\(*b", 7),
        ("a\\(b", 2),
        ("a\\\\b", 2),
        ("a\\]", 2),
        ("aa", 2),
        ("aaaa|bbbb|cccc|ddddd|eeeeee|fffffff|gggg|hhhh|iiiii|jjjjj|kkkkk|llll", 24),
        ("aaac|aabc|abac|abbc|baac|babc|bbac|bbbc", 16),
        ("ab*", 6),
        ("ab*bc", 7),
        ("ab*c", 7),
        ("ab+bc", 5),
        ("ab?bc", 5),
        ("ab?c", 5),
        ("abaa|abbaa|abbbaa|abbbbaa", 8),
        ("aba|bab", 4),
        ("aba|bab|bba", 6),
        ("abc", 2),
        ("abc$", 3),
        ("abcd*efg", 7),
        ("ab{0,1}bc", 5),
        ("ab{0,1}c", 5),
        ("ab{0,}bc", 7),
        ("ab{1,3}bc", 8),
        ("ab{1,}bc", 5),
        ("ab{3,4}bc", 8),
        ("ab{4,5}bc", 9),
        ("ab|a", 4),
        ("ab|abab", 4),
        ("ab|cd", 4),
        ("a{0}b", 3),
        ("a{1,}b{1,}c", 6),
        ("a|b|c|d|e", 10),
        ("d[ex][fy]$", 5),
        ("def$", 3),
        ("foo|bar|[A-Z]", 6),
        ("h.*o", 7),
        ("h.*od?", 11),
        ("multiple words", 2),
        ("multiple words of text", 2),
        ("x\\B", 3),
        ("x\\b", 3),
        ("z\\B", 3),
    ],
)
def test_epsilons_reduced(pattern, upper_bound):
    assert RegexNFA(pattern).n_transitions() <= upper_bound
